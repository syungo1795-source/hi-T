# -*- coding: utf-8 -*-
"""ã‚«ãƒ­ãƒªãƒ¼ã‚­ãƒ³ã‚°.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1EdNiYY1I92qOUtxBOGCqrDZbdv5qGEwk
"""

import streamlit as st
import random

# --- 1. ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã®è¨­å®š ---
# æ–™ç†å, åˆ†é‡(g), ã‚«ãƒ­ãƒªãƒ¼(kcal)
FOOD_DATA = [
    {"food": "ç™½ç±³", "weight": "250g", "calories": 390},
    {"food": "ç‰›ä¸¼", "weight": "400g", "calories": 730},
    {"food": "é‡èœç‚’ã‚", "weight": "250g", "calories": 180},
    {"food": "é¶ã®å”æšã’ï¼ˆ5å€‹ï¼‰", "weight": "150g", "calories": 450},
    {"food": "å‘³å™Œãƒ©ãƒ¼ãƒ¡ãƒ³", "weight": "600g", "calories": 550},
    {"food": "ãƒãƒ³ãƒãƒ¼ã‚°ã‚¹ãƒ†ãƒ¼ã‚­", "weight": "200g", "calories": 450},
    {"food": "ã‚«ãƒ¬ãƒ¼ãƒ©ã‚¤ã‚¹", "weight": "500g", "calories": 850},
    {"food": "ç„¼ãé­šï¼ˆãƒ›ãƒƒã‚±ï¼‰", "weight": "200g", "calories": 220},
    {"food": "ãƒãƒ†ãƒˆã‚µãƒ©ãƒ€", "weight": "120g", "calories": 210},
    {"food": "ã¨ã‚“ã‹ã¤", "weight": "150g", "calories": 500},
]

# --- 2. ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®åˆæœŸåŒ– ---
if "history" not in st.session_state:
    st.session_state.history = []  # å…¨è§£ç­”å±¥æ­´
if "wrong_indices" not in st.session_state:
    st.session_state.wrong_indices = set()  # é–“é•ãˆãŸå•é¡Œã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆé‡è¤‡ãªã—ï¼‰
if "current_question" not in st.session_state:
    st.session_state.current_question = random.choice(FOOD_DATA)

# --- 3. ã‚¢ãƒ—ãƒªã®æ§‹æˆ ---
st.title("ğŸ½ï¸ æ–™ç†ã‚«ãƒ­ãƒªãƒ¼å½“ã¦ã‚¯ã‚¤ã‚º")
st.caption("ä¸€èˆ¬æˆäººç”·æ€§ã®1é£Ÿåˆ†ç¨‹åº¦ã®åˆ†é‡ã§å‡ºé¡Œã—ã¾ã™")

menu = st.sidebar.selectbox("ãƒ¡ãƒ‹ãƒ¥ãƒ¼", ["ã‚¯ã‚¤ã‚ºã«æŒ‘æˆ¦", "å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰", "è§£ç­”å±¥æ­´ã¨å‚¾å‘"])

# --- é–¢æ•°ï¼šå›ç­”ãƒã‚§ãƒƒã‚¯ ---
def check_answer(user_val, correct_val, food_info):
    # èª¤å·®Â±10%ä»¥å†…ãªã‚‰æ­£è§£ã¨ã™ã‚‹ï¼ˆæ•°å€¤å…¥åŠ›ã®å ´åˆã®é…æ…®ï¼‰
    is_correct = abs(user_val - correct_val) <= (correct_val * 0.1)

    result = {
        "æ–™ç†": food_info["food"],
        "åˆ†é‡": food_info["weight"],
        "ã‚ãªãŸã®å›ç­”": f"{user_val} kcal",
        "æ­£è§£": f"{correct_val} kcal",
        "åˆ¤å®š": "â­• æ­£è§£" if is_correct else "âŒ ä¸æ­£è§£"
    }

    st.session_state.history.append(result)

    if not is_correct:
        # é–“é•ãˆãŸæ–™ç†ã®åå‰ã‚’å¾©ç¿’ãƒªã‚¹ãƒˆã«è¿½åŠ 
        st.session_state.wrong_indices.add(food_info["food"])
        st.error(f"æ®‹å¿µï¼æ­£è§£ã¯ {correct_val} kcal ã§ã—ãŸã€‚")
    else:
        st.success(f"æ­£è§£ã§ã™ï¼ ({correct_val} kcal)")

    # æ¬¡ã®å•é¡Œã¸
    st.session_state.current_question = random.choice(FOOD_DATA)

# --- ãƒ¢ãƒ¼ãƒ‰1ï¼šé€šå¸¸ã‚¯ã‚¤ã‚º ---
if menu == "ã‚¯ã‚¤ã‚ºã«æŒ‘æˆ¦":
    q = st.session_state.current_question
    st.subheader(f"å•é¡Œï¼š{q['food']}ï¼ˆ{q['weight']}ï¼‰ã®ã‚«ãƒ­ãƒªãƒ¼ã¯ï¼Ÿ")

    user_input = st.number_input("äºˆæƒ³ã‚«ãƒ­ãƒªãƒ¼(kcal)ã‚’å…¥åŠ›", min_value=0, step=10, key="normal_quiz")

    if st.button("å›ç­”ã™ã‚‹"):
        check_answer(user_input, q["calories"], q)

# --- ãƒ¢ãƒ¼ãƒ‰2ï¼šå¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ ---
elif menu == "å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰":
    st.subheader("ğŸ“ éå»ã«é–“é•ãˆãŸå•é¡Œ")

    if not st.session_state.wrong_indices:
        st.info("ç¾åœ¨ã€å¾©ç¿’ãŒå¿…è¦ãªå•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ç´ æ™´ã‚‰ã—ã„ï¼")
    else:
        # é–“é•ãˆãŸæ–™ç†ã®ãƒ‡ãƒ¼ã‚¿ã ã‘ã‚’æŠ½å‡º
        review_list = [f for f in FOOD_DATA if f["food"] in st.session_state.wrong_indices]
        q_review = random.choice(review_list)

        st.write(f"å†æŒ‘æˆ¦ï¼š**{q_review['food']}ï¼ˆ{q_review['weight']}ï¼‰**")
        user_input_review = st.number_input("äºˆæƒ³ã‚«ãƒ­ãƒªãƒ¼(kcal)ã‚’å…¥åŠ›", min_value=0, step=10, key="review_quiz")

        if st.button("å›ç­”ã™ã‚‹"):
            # æ­£è§£ã—ãŸã‚‰å¾©ç¿’ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
            is_correct = abs(user_input_review - q_review["calories"]) <= (q_review["calories"] * 0.1)
            if is_correct:
                st.session_state.wrong_indices.remove(q_review["food"])
                st.success("å¾©ç¿’æˆåŠŸï¼ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚")

            check_answer(user_input_review, q_review["calories"], q_review)

# --- ãƒ¢ãƒ¼ãƒ‰3ï¼šå±¥æ­´è¡¨ç¤º ---
elif menu == "è§£ç­”å±¥æ­´ã¨å‚¾å‘":
    st.subheader("ğŸ“Š ã“ã‚Œã¾ã§ã®è§£ç­”å±¥æ­´")
    if st.session_state.history:
        st.table(st.session_state.history)
        if st.button("å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ"):
            st.session_state.history = []
            st.session_state.wrong_indices = set()
            st.rerun()
    else:
        st.write("ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚")